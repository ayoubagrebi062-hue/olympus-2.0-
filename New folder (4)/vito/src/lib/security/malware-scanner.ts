/**
 * OLYMPUS 2.1 - SECURITY BLUEPRINT
 * Malware Scanner - Detects malicious patterns in generated code
 * 
 * Scans OLYMPUS-generated code for:
 * - Crypto miners
 * - Keyloggers
 * - Data exfiltration
 * - Backdoors
 * - Reverse shells
 */

// ═══════════════════════════════════════════════════════════════════════════════
// MALWARE PATTERNS
// ═══════════════════════════════════════════════════════════════════════════════

export interface MalwarePattern {
  name: string;
  category: MalwareCategory;
  pattern: RegExp;
  severity: 'critical' | 'high' | 'medium';
  description: string;
  ioc: string; // Indicator of Compromise
}

export type MalwareCategory = 
  | 'crypto_miner'
  | 'keylogger'
  | 'data_exfiltration'
  | 'backdoor'
  | 'reverse_shell'
  | 'obfuscation'
  | 'persistence'
  | 'credential_theft';

export const MALWARE_PATTERNS: MalwarePattern[] = [
  // Crypto Miners
  {
    name: 'CoinHive Miner',
    category: 'crypto_miner',
    pattern: /coinhive\.min\.js|CoinHive\.Anonymous/gi,
    severity: 'critical',
    description: 'CoinHive cryptocurrency miner script',
    ioc: 'Known crypto mining library',
  },
  {
    name: 'CryptoLoot Miner',
    category: 'crypto_miner',
    pattern: /cryptoloot\.pro|CRLT\.Anonymous/gi,
    severity: 'critical',
    description: 'CryptoLoot cryptocurrency miner',
    ioc: 'Known crypto mining library',
  },
  {
    name: 'Generic WebAssembly Miner',
    category: 'crypto_miner',
    pattern: /WebAssembly\.instantiate.*cryptonight|wasm.*miner/gi,
    severity: 'high',
    description: 'Potential WebAssembly-based crypto miner',
    ioc: 'WebAssembly + crypto mining keywords',
  },
  {
    name: 'Mining Pool Connection',
    category: 'crypto_miner',
    pattern: /stratum\+tcp:\/\/|mining\.(pool|proxy)|xmr\.pool/gi,
    severity: 'critical',
    description: 'Connection to cryptocurrency mining pool',
    ioc: 'Mining pool protocol or URL',
  },

  // Keyloggers
  {
    name: 'Keyboard Event Logger',
    category: 'keylogger',
    pattern: /document\.onkey(down|press|up)\s*=.*fetch|addEventListener\s*\(\s*['"]key(down|press|up)['"].*XMLHttpRequest/gi,
    severity: 'critical',
    description: 'Keyboard events sent to external server',
    ioc: 'Keyboard events + network transmission',
  },
  {
    name: 'Form Input Interceptor',
    category: 'keylogger',
    pattern: /querySelectorAll\s*\(\s*['"]input['"\]].*addEventListener.*change.*fetch/gi,
    severity: 'high',
    description: 'Form inputs being intercepted and sent externally',
    ioc: 'Input monitoring + network call',
  },
  {
    name: 'Clipboard Hijacker',
    category: 'keylogger',
    pattern: /navigator\.clipboard\.(readText|read)\s*\(\s*\).*fetch|document\.execCommand\s*\(\s*['"]paste['"].*XMLHttpRequest/gi,
    severity: 'critical',
    description: 'Clipboard contents being stolen',
    ioc: 'Clipboard access + network transmission',
  },

  // Data Exfiltration
  {
    name: 'Cookie Theft',
    category: 'data_exfiltration',
    pattern: /document\.cookie.*(?:fetch|XMLHttpRequest|Image\s*\(\s*\)|new\s+WebSocket)/gi,
    severity: 'critical',
    description: 'Cookies being sent to external server',
    ioc: 'Cookie access + network call',
  },
  {
    name: 'LocalStorage Theft',
    category: 'data_exfiltration',
    pattern: /localStorage\.(getItem|key).*(?:fetch|XMLHttpRequest|navigator\.sendBeacon)/gi,
    severity: 'high',
    description: 'LocalStorage data being exfiltrated',
    ioc: 'Storage access + network transmission',
  },
  {
    name: 'Form Data Hijacking',
    category: 'data_exfiltration',
    pattern: /FormData.*(?:append|set).*(?:password|credit|card|ssn|cvv).*fetch/gi,
    severity: 'critical',
    description: 'Sensitive form data being stolen',
    ioc: 'Sensitive field names + network call',
  },
  {
    name: 'Screenshot Capture',
    category: 'data_exfiltration',
    pattern: /html2canvas|dom-to-image|toDataURL.*(?:fetch|XMLHttpRequest)/gi,
    severity: 'high',
    description: 'Screen capture being sent externally',
    ioc: 'Screenshot library + network transmission',
  },

  // Backdoors
  {
    name: 'Eval from Remote',
    category: 'backdoor',
    pattern: /fetch\s*\([^)]+\)\s*\.then[^}]+eval|eval\s*\(\s*await\s+fetch/gi,
    severity: 'critical',
    description: 'Remote code execution via eval',
    ioc: 'Fetch + eval combination',
  },
  {
    name: 'Dynamic Script Injection',
    category: 'backdoor',
    pattern: /createElement\s*\(\s*['"]script['"].*src\s*=.*(?:http|\/\/)/gi,
    severity: 'high',
    description: 'Dynamic script tag with external source',
    ioc: 'Script element + external URL',
  },
  {
    name: 'Function Constructor RCE',
    category: 'backdoor',
    pattern: /new\s+Function\s*\([^)]*fetch[^)]*\)|Function\s*\(\s*['"][^'"]*(?:http|fetch)[^'"]*['"]\s*\)/gi,
    severity: 'critical',
    description: 'Function constructor executing remote code',
    ioc: 'Function constructor + network',
  },
  {
    name: 'WebSocket Command Channel',
    category: 'backdoor',
    pattern: /new\s+WebSocket.*onmessage.*eval|WebSocket.*on\s*\(\s*['"]message['"].*Function/gi,
    severity: 'critical',
    description: 'WebSocket used for command and control',
    ioc: 'WebSocket + code execution',
  },

  // Reverse Shells
  {
    name: 'Node.js Reverse Shell',
    category: 'reverse_shell',
    pattern: /child_process.*spawn.*\/bin\/(ba)?sh|exec\s*\(\s*['"].*nc\s+-e/gi,
    severity: 'critical',
    description: 'Node.js reverse shell attempt',
    ioc: 'Child process + shell',
  },
  {
    name: 'Python Reverse Shell',
    category: 'reverse_shell',
    pattern: /socket\.socket.*connect.*os\.dup2|subprocess.*shell=True.*socket/gi,
    severity: 'critical',
    description: 'Python reverse shell pattern',
    ioc: 'Socket + shell subprocess',
  },

  // Obfuscation (suspicious but not always malicious)
  {
    name: 'Heavy Base64 Usage',
    category: 'obfuscation',
    pattern: /atob\s*\(\s*['"][A-Za-z0-9+/=]{100,}['"]\s*\)/g,
    severity: 'medium',
    description: 'Large base64 encoded string being decoded',
    ioc: 'Large base64 payload',
  },
  {
    name: 'Char Code Obfuscation',
    category: 'obfuscation',
    pattern: /String\.fromCharCode\s*\(\s*(?:\d+\s*,\s*){10,}/g,
    severity: 'medium',
    description: 'String built from character codes (obfuscation)',
    ioc: 'Many fromCharCode calls',
  },
  {
    name: 'Hex Escape Obfuscation',
    category: 'obfuscation',
    pattern: /\\x[0-9a-f]{2}(?:\\x[0-9a-f]{2}){20,}/gi,
    severity: 'medium',
    description: 'Heavy hex escape sequence (obfuscation)',
    ioc: 'Many hex escapes',
  },

  // Persistence
  {
    name: 'Service Worker Hijacking',
    category: 'persistence',
    pattern: /navigator\.serviceWorker\.register.*(?:fetch|cache).*(?:http[^'"\s]+)/gi,
    severity: 'high',
    description: 'Service worker with suspicious network activity',
    ioc: 'Service worker + external fetch',
  },
  {
    name: 'Browser Extension Injection',
    category: 'persistence',
    pattern: /chrome\.runtime|browser\.runtime.*(?:sendMessage|connect)/gi,
    severity: 'high',
    description: 'Browser extension API usage',
    ioc: 'Extension runtime API',
  },

  // Credential Theft
  {
    name: 'Password Field Monitoring',
    category: 'credential_theft',
    pattern: /querySelector.*type=['"]password['"].*addEventListener|getElementsByName.*password.*value/gi,
    severity: 'critical',
    description: 'Password field being monitored',
    ioc: 'Password selector + event listener',
  },
  {
    name: 'Fake Login Form',
    category: 'credential_theft',
    pattern: /innerHTML.*<form.*password.*action=['"]http/gi,
    severity: 'critical',
    description: 'Injected login form with external action',
    ioc: 'innerHTML + login form + external URL',
  },
];

// ═══════════════════════════════════════════════════════════════════════════════
// BLOCKLISTED DOMAINS
// ═══════════════════════════════════════════════════════════════════════════════

export const BLOCKLISTED_DOMAINS = [
  // Known malware domains
  'coinhive.com',
  'coin-hive.com',
  'cryptoloot.pro',
  'authedmine.com',
  'crypto-loot.com',
  'webminerpool.com',
  'minero.cc',
  
  // Data exfiltration services
  'webhook.site',
  'requestbin.com',
  'ngrok.io',
  'pipedream.net',
  'beeceptor.com',
  
  // Paste services (for exfil)
  'pastebin.com',
  'ghostbin.com',
  'hastebin.com',
];

// ═══════════════════════════════════════════════════════════════════════════════
// DETECTION RESULT
// ═══════════════════════════════════════════════════════════════════════════════

export interface MalwareMatch {
  pattern: string;
  category: MalwareCategory;
  severity: 'critical' | 'high' | 'medium';
  description: string;
  ioc: string;
  match: string;
  line: number;
  column: number;
  context: string;
}

export interface MalwareScanResult {
  hasMalware: boolean;
  matches: MalwareMatch[];
  criticalCount: number;
  highCount: number;
  mediumCount: number;
  blockedDomains: string[];
  categories: MalwareCategory[];
  summary: string;
  recommendation: string;
}

// ═══════════════════════════════════════════════════════════════════════════════
// SCANNER
// ═══════════════════════════════════════════════════════════════════════════════

function getLineAndColumn(content: string, index: number): { line: number; column: number } {
  const lines = content.substring(0, index).split('\n');
  return {
    line: lines.length,
    column: lines[lines.length - 1].length + 1,
  };
}

function getContext(content: string, index: number, matchLength: number): string {
  const contextStart = Math.max(0, index - 40);
  const contextEnd = Math.min(content.length, index + matchLength + 40);
  let context = content.substring(contextStart, contextEnd);
  
  if (contextStart > 0) context = '...' + context;
  if (contextEnd < content.length) context = context + '...';
  
  return context.replace(/\n/g, ' ').trim();
}

function findBlockedDomains(content: string): string[] {
  const found: string[] = [];
  
  for (const domain of BLOCKLISTED_DOMAINS) {
    if (content.toLowerCase().includes(domain)) {
      found.push(domain);
    }
  }
  
  return [...new Set(found)];
}

export function scanForMalware(content: string): MalwareScanResult {
  const matches: MalwareMatch[] = [];

  for (const pattern of MALWARE_PATTERNS) {
    pattern.pattern.lastIndex = 0;
    
    let match;
    while ((match = pattern.pattern.exec(content)) !== null) {
      const { line, column } = getLineAndColumn(content, match.index);
      
      matches.push({
        pattern: pattern.name,
        category: pattern.category,
        severity: pattern.severity,
        description: pattern.description,
        ioc: pattern.ioc,
        match: match[0].substring(0, 100) + (match[0].length > 100 ? '...' : ''),
        line,
        column,
        context: getContext(content, match.index, match[0].length),
      });
    }
  }

  const blockedDomains = findBlockedDomains(content);
  
  // Add blocked domain matches
  for (const domain of blockedDomains) {
    const index = content.toLowerCase().indexOf(domain);
    const { line, column } = getLineAndColumn(content, index);
    
    matches.push({
      pattern: 'Blocklisted Domain',
      category: 'data_exfiltration',
      severity: 'critical',
      description: `Connection to blocklisted domain: ${domain}`,
      ioc: 'Known malicious or suspicious domain',
      match: domain,
      line,
      column,
      context: getContext(content, index, domain.length),
    });
  }

  // Sort by severity
  matches.sort((a, b) => {
    const order = { critical: 0, high: 1, medium: 2 };
    return order[a.severity] - order[b.severity];
  });

  const criticalCount = matches.filter(m => m.severity === 'critical').length;
  const highCount = matches.filter(m => m.severity === 'high').length;
  const mediumCount = matches.filter(m => m.severity === 'medium').length;
  const categories = [...new Set(matches.map(m => m.category))];

  const hasMalware = criticalCount > 0 || highCount > 0;

  let summary = 'No malware patterns detected';
  let recommendation = 'Code appears safe';
  
  if (matches.length > 0) {
    summary = `Found ${matches.length} suspicious pattern(s): ${criticalCount} critical, ${highCount} high, ${mediumCount} medium`;
    
    if (criticalCount > 0) {
      recommendation = 'BLOCK THIS CODE - Critical malware patterns detected';
    } else if (highCount > 0) {
      recommendation = 'Manual review required before deployment';
    } else {
      recommendation = 'Low risk - review flagged patterns';
    }
  }

  return {
    hasMalware,
    matches,
    criticalCount,
    highCount,
    mediumCount,
    blockedDomains,
    categories,
    summary,
    recommendation,
  };
}

// ═══════════════════════════════════════════════════════════════════════════════
// EXPORT
// ═══════════════════════════════════════════════════════════════════════════════

export const MALWARE_SCANNER = {
  patterns: MALWARE_PATTERNS,
  blockedDomains: BLOCKLISTED_DOMAINS,
  scan: scanForMalware,
};
