const { createClient } = require('@supabase/supabase-js');

const client = createClient(
  'https://bxkrwzrisoqtojhpjdrw.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4a3J3enJpc29xdG9qaHBqZHJ3Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NzcwODA1NCwiZXhwIjoyMDgzMjg0MDU0fQ.cJuOd_AX188y4la5cxMwkzNXtU2RC0YFq0oL0XEEwnI'
);

async function main() {
  const buildId = 'bbb38798-2522-4214-aacc-906fbbc70779';

  console.log('Checking build artifacts for:', buildId);
  console.log('');

  // Get all agent outputs
  const { data, error } = await client
    .from('build_agent_outputs')
    .select('agent_id, status, artifacts')
    .eq('build_id', buildId);

  if (error) {
    console.log('Error:', error.message);
    return;
  }

  console.log('Total agents with outputs:', data?.length || 0);
  console.log('');

  // Check for config files
  const configFiles = ['package.json', 'tsconfig.json', 'tsconfig.node.json', 'postcss.config.js', 'tailwind.config', 'next.config'];
  const foundConfigs = {};

  for (const row of data || []) {
    const artifacts = row.artifacts || [];
    for (const a of artifacts) {
      const path = a.path || '';
      for (const cfg of configFiles) {
        if (path.includes(cfg)) {
          foundConfigs[cfg] = { agent: row.agent_id, path: path };
        }
      }
    }
  }

  console.log('=== CONFIG FILES FOUND ===');
  for (const cfg of configFiles) {
    if (foundConfigs[cfg]) {
      console.log(`✓ ${cfg} - generated by ${foundConfigs[cfg].agent}`);
    } else {
      console.log(`✗ ${cfg} - MISSING`);
    }
  }

  console.log('');
  console.log('=== ARCHON OUTPUT ===');
  const archon = data?.find(d => d.agent_id === 'archon');
  if (archon) {
    console.log('Status:', archon.status);
    console.log('Artifacts:', (archon.artifacts || []).length);
    for (const a of (archon.artifacts || []).slice(0, 5)) {
      console.log('  -', a.type, '|', a.path || 'no-path');
    }
  } else {
    console.log('No ARCHON output found');
  }

  console.log('');
  console.log('=== FORGE OUTPUT ===');
  const forge = data?.find(d => d.agent_id === 'forge');
  if (forge) {
    console.log('Status:', forge.status);
    console.log('Artifacts:', (forge.artifacts || []).length);
    for (const a of (forge.artifacts || []).slice(0, 5)) {
      console.log('  -', a.type, '|', a.path || 'no-path');
    }
  } else {
    console.log('No FORGE output found');
  }
}

main().catch(console.error);
