#!/bin/sh
# OLYMPUS Pre-Commit Quality Gate v1.1
# CHAOS-HARDENED: Fixed SIGKILL, added file size guard

START_TIME=$(date +%s)
MAX_FILE_SIZE_KB=5000  # 5MB limit

echo ""
echo "╔══════════════════════════════════════════════════════════════════╗"
echo "║  🔍 PRE-COMMIT QUALITY GATE                                      ║"
echo "╚══════════════════════════════════════════════════════════════════╝"
echo ""

# Check for required dependencies
command -v npx >/dev/null 2>&1 || {
  echo "╔══════════════════════════════════════════════════════════════════╗"
  echo "║  ❌ MISSING DEPENDENCY: npx not found                            ║"
  echo "║  Install Node.js: https://nodejs.org                             ║"
  echo "╚══════════════════════════════════════════════════════════════════╝"
  exit 1
}

# Step 0: Check for large files (prevents accidental binary commits)
echo "📏 Checking file sizes..."
LARGE_FILES=$(git diff --cached --name-only | while read file; do
  if [ -f "$file" ]; then
    SIZE_KB=$(du -k "$file" 2>/dev/null | cut -f1)
    if [ "$SIZE_KB" -gt "$MAX_FILE_SIZE_KB" ] 2>/dev/null; then
      echo "    $file (${SIZE_KB}KB)"
    fi
  fi
done)

if [ -n "$LARGE_FILES" ]; then
  echo ""
  echo "╔══════════════════════════════════════════════════════════════════╗"
  echo "║  ❌ LARGE FILES DETECTED (>${MAX_FILE_SIZE_KB}KB)                            ║"
  echo "╠══════════════════════════════════════════════════════════════════╣"
  echo "$LARGE_FILES"
  echo "║                                                                  ║"
  echo "║  Options:                                                        ║"
  echo "║    1. Add to .gitignore                                          ║"
  echo "║    2. Use Git LFS for large files                                ║"
  echo "║    3. Bypass: git commit --no-verify                             ║"
  echo "╚══════════════════════════════════════════════════════════════════╝"
  exit 1
fi
echo "    ✓ No oversized files"

# Step 1: Format staged files with Prettier (per-file, fast)
echo ""
echo "📝 Formatting staged files..."
STEP_START=$(date +%s)
npx lint-staged || {
  END_TIME=$(date +%s)
  DURATION=$((END_TIME - START_TIME))
  echo ""
  echo "╔══════════════════════════════════════════════════════════════════╗"
  echo "║  ❌ COMMIT BLOCKED - Formatting failed (${DURATION}s)                   ║"
  echo "╠══════════════════════════════════════════════════════════════════╣"
  echo "║  Prettier encountered an error. Check syntax.                    ║"
  echo "║  Bypass: git commit --no-verify -m \"message\"                     ║"
  echo "╚══════════════════════════════════════════════════════════════════╝"
  exit 1
}
STEP_END=$(date +%s)
echo "    ✓ Formatting OK ($((STEP_END - STEP_START))s)"

# Step 2: TypeScript check (ONCE for entire project, not per-file)
# This prevents SIGKILL/OOM on large commits
echo ""
echo "📦 TypeScript check (project-wide)..."
STEP_START=$(date +%s)
npx tsc --noEmit 2>&1 | tail -20
TS_EXIT=${PIPESTATUS[0]}
STEP_END=$(date +%s)

if [ $TS_EXIT -ne 0 ]; then
  echo ""
  echo "╔══════════════════════════════════════════════════════════════════╗"
  echo "║  ❌ COMMIT BLOCKED - TypeScript errors ($((STEP_END - STEP_START))s)                    ║"
  echo "╠══════════════════════════════════════════════════════════════════╣"
  echo "║  Run: npm run type-check                                         ║"
  echo "║  Bypass: git commit --no-verify -m \"message\"                     ║"
  echo "╚══════════════════════════════════════════════════════════════════╝"
  exit 1
fi
echo "    ✓ TypeScript OK ($((STEP_END - STEP_START))s)"

END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

echo ""
echo "╔══════════════════════════════════════════════════════════════════╗"
echo "║  ✅ Quality gate passed (${DURATION}s)                                   ║"
echo "║     Size ✓  Prettier ✓  TypeScript ✓                              ║"
echo "╚══════════════════════════════════════════════════════════════════╝"
echo ""
